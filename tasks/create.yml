---
- name: Create | set branch name
  set_fact:
    branch: "{{ branch_item }}"

- debug:
    msg: "Creating new branch {{ branch }}"

- name: Create | Create site branch directory
  file:
    path: "{{ buildbranches.build_dir }}/{{ branch }}"
    state: directory

- name: Create | Copy site files
  shell: "rsync -aAX --inplace {% for path in buildbranches.sync_exclude %}--exclude {{ path }} {% endfor %}master/ {{ branch }}/"
  args:
    chdir: "{{ buildbranches.build_dir }}"

- name: Create | Create DB
  become: yes
  mysql_db:
    name: "{{ item.name }}_{{ branch }}"
    state: present
    encoding: "utf8"
    collation: "utf8_general_ci"
  with_items: "{{ buildbranches.databases }}"

- name: Create | Import DB SQL file
  become: yes
  mysql_db:
    name: "{{ item.name }}_{{ branch }}"
    state: import
    target: "{{ item.target }}"
  with_items: "{{ buildbranches.databases }}"

- name: Create | Ensure custom settings are present
  copy:
    content: "{{ item.value | regex_replace('REPLACEBRANCH', branch) }}"
    dest: "{{ buildbranches.build_dir }}/{{ branch }}/{{ item.dest }}"
    follow: yes
  with_items: "{{ buildbranches.configs }}"
  no_log: True
  tags: config

- name: Create | Run update tasks
  include: update.yml
  vars:
    item: "{{ branch }}"
